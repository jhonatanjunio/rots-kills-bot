# üéÆ ROTS War Bot

## üìã Sobre
Bot do Discord desenvolvido para monitorar e gerenciar estat√≠sticas de jogadores do Saiyans Return (ROTS). O bot rastreia mortes (PvP e PvE), mant√©m rankings, envia alertas e fornece informa√ß√µes detalhadas sobre o desempenho dos jogadores aliados e inimigos.

### üéØ **Principais Melhorias Recentes**
- ‚úÖ **Sistema de Rate Limiting Inteligente**: Solu√ß√£o robusta que elimina completamente os problemas de erro 429
- ‚úÖ **Recupera√ß√£o Autom√°tica**: Bot nunca mais trava e se recupera automaticamente de qualquer problema
- ‚úÖ **Logs Limpos**: Console organizado sem spam de erros, apenas informa√ß√µes relevantes
- ‚úÖ **Monitoramento em Tempo Real**: Comando `/systemstatus` para acompanhar a sa√∫de do sistema
- ‚úÖ **Otimiza√ß√£o Autom√°tica**: Sistema se ajusta automaticamente para m√°xima efici√™ncia e estabilidade

## ‚ö° Funcionalidades Atuais

### 1. Monitoramento de Jogadores
- Rastreamento autom√°tico de mortes (PvP e PvE)
- Sistema de aliados e inimigos
- Atualiza√ß√£o em tempo real das informa√ß√µes dos jogadores
- Detec√ß√£o e registro de troca de classe e mudan√ßa de nick

### 2. Comandos Discord Dispon√≠veis
- `/addplayer` ‚Äî Adiciona um jogador ao monitoramento (aliado ou inimigo)
- `/removeplayer` ‚Äî Remove um jogador do monitoramento
- `/playerstats` ‚Äî Exibe estat√≠sticas detalhadas do jogador (n√≠vel, mortes, assassino mais frequente, √∫ltima morte, etc)
- `/ranking` ‚Äî Mostra ranking de KDA (Kills/Deaths/Assists) dos aliados, com op√ß√£o de per√≠odo (24h, 7d, 30d, total)
- `/war` ‚Äî Mostra estat√≠sticas de guerra entre aliados e inimigos em um per√≠odo customiz√°vel (ex: 1d, 2h 30m)
- `/systemstatus` ‚Äî Exibe status detalhado do sistema de monitoramento, rate limiting e rob√¥s
- `/shutdown` ‚Äî Desliga o bot de forma segura

### 3. Sistema de Estat√≠sticas
- Contagem de mortes por jogador
- Rastreamento de KDA (Kills, Deaths, Assists)
- Hist√≥rico de combates detalhado
- An√°lise de per√≠odos customiz√°veis (24h, 7d, 30d, total)
- Ranking visual (imagem) e em tabela ASCII

### 4. Notifica√ß√µes e Alertas
- Alertas de morte em tempo real (PvP e PvE) via Discord Embed
- Detalhes do combate (quem matou, maior dano, hor√°rio, etc)
- Notifica√ß√µes de troca de classe e mudan√ßa de nick
- Logs separados para mortes por monstros

### 5. Sistema de Rate Limiting Inteligente üß†
- **Persist√™ncia de estado**: Salva progresso e configura√ß√µes automaticamente
- **Cooldown adaptativo**: Ajusta automaticamente baseado no hist√≥rico de erros
- **Pausa global inteligente**: Para o sistema automaticamente ap√≥s m√∫ltiplos erros 429
- **Recupera√ß√£o autom√°tica**: Retoma processamento quando seguro
- **An√°lise de tend√™ncias**: Monitora padr√µes de erro em tempo real
- **Otimiza√ß√£o autom√°tica**: Reduz cooldowns quando sistema est√° est√°vel
- **Logs categorizados**: Sistema de logs inteligente que evita spam no console

### 6. Recursos T√©cnicos e Arquiteturais
- Cache inteligente para evitar requisi√ß√µes duplicadas √† API
- Sistema de filas e rob√¥s para processamento paralelo dos jogadores
- Sistema de backup e restaura√ß√£o autom√°tica do banco de dados
- Logging detalhado e tratamento robusto de erros
- Prote√ß√£o contra duplica√ß√£o de dados e rate limiting avan√ßado
- Persist√™ncia de estado para recupera√ß√£o ap√≥s reinicializa√ß√µes
- Sistema de monitoramento em tempo real com m√©tricas detalhadas

### 7. Seguran√ßa
- Rate limiting inteligente para evitar banimento por excesso de requisi√ß√µes
- Sistema de recupera√ß√£o autom√°tica ap√≥s bloqueios tempor√°rios
- Valida√ß√£o de entradas e gerenciamento seguro de tokens
- Detec√ß√£o e tratamento diferenciado para erros 403, 429 e timeouts

## üîß Tecnologias Utilizadas

- **TypeScript** (strict mode) ‚Äî Tipagem forte e desenvolvimento seguro
- **Discord.js** ‚Äî Integra√ß√£o completa com Discord API
- **Puppeteer** ‚Äî Automa√ß√£o de browser para intera√ß√£o com APIs
- **Jest** ‚Äî Framework de testes automatizados
- **Node.js** ‚Äî Runtime de alta performance
- **Moment.js** ‚Äî Manipula√ß√£o avan√ßada de datas
- **Sistema de Persist√™ncia** ‚Äî Gerenciamento de estado com arquivos JSON
- **Rate Limiting Adaptativo** ‚Äî Algoritmos inteligentes de controle de requisi√ß√µes

## üíª Arquitetura

O projeto est√° organizado em v√°rios m√≥dulos principais:

1. **Servi√ßos Core**
   - BrowserService: Intera√ß√£o inteligente com a API do jogo
   - DeathMonitor: Sistema de monitoramento em tempo real
   - Database: Gerenciamento de dados com backup autom√°tico
   - GameAPI: Interface com a API do jogo
   - QueueService: Processamento paralelo com rob√¥s
   - RateLimitStateService: Gest√£o inteligente de rate limiting
   - SmartLogger: Sistema de logs categorizados e otimizados

2. **Comandos Discord**
   - Sistema modular de comandos
   - Gerenciamento de intera√ß√µes
   - Formata√ß√£o rica de mensagens

3. **Sistema de Testes**
   - Testes de integra√ß√£o
   - Mocks para servi√ßos externos
   - Ambiente de teste isolado

## üöÄ Destaques T√©cnicos

1. **Sistema de Cache Inteligente**
- Implementa√ß√£o de cache em mem√≥ria para reduzir requisi√ß√µes √† API
- √çndice otimizado para logs de morte usando Set para evitar duplicatas
- Sistema de hash para identifica√ß√£o √∫nica de eventos
```typescript
private static createDeathLogHash(deathLog: DeathLogEntry): string {
return `${deathLog.playerName}-${deathLog.killed_by}-${deathLog.mostdamage_by}-${deathLog.timestamp}-${deathLog.level}`;
}
```

2. **Monitoramento em Tempo Real**
- Sistema robusto de monitoramento usando Puppeteer
- Processamento ass√≠ncrono de eventos de morte
- Notifica√ß√µes instant√¢neas via Discord Embeds
```typescript
private async processNewDeaths(player: any, deaths: any[]) {
  const deathAlert = new EmbedBuilder()
    .setColor('#FF0000')
    .setTitle('‚ö†Ô∏è ALERTA DE MORTE ‚ö†Ô∏è')
    // ... configura√ß√£o do embed
    .setFooter({ text: 'Mantenha-se alerta! Proteja seus aliados!' });
}
```

3. **Interface Rica com Discord**
- Comandos Slash integrados
- Embeds personalizados para melhor visualiza√ß√£o
- Sistema de rankings com per√≠odos customiz√°veis
```typescript
export async function showRanking(interaction: ChatInputCommandInteraction) {
  const period = interaction.options.getString('period');
  const options = parseRankingPeriod(period);
  // ... l√≥gica de ranking
}
```

4. **Sistema de Testes Abrangente**
- Mocks para servi√ßos externos
- Testes de integra√ß√£o automatizados
- Ambiente de teste isolado
```typescript
describe('DeathMonitor', () => {
  let monitor: DeathMonitor;
  let mockClient: Client;
  // ... configura√ß√£o de testes
});
```

5. **Sistema de Rate Limiting Inteligente**
- Persist√™ncia de estado para recupera√ß√£o ap√≥s reinicializa√ß√µes
- An√°lise de tend√™ncias de erro e recomenda√ß√µes autom√°ticas
- Otimiza√ß√£o autom√°tica do cooldown baseada em performance
```typescript
// Sistema adaptativo que ajusta cooldowns baseado no hist√≥rico
async optimizeCooldown(): Promise<void> {
  const stats = this.analyzeCurrentState();
  if (stats.successRate > 95 && this.state.globalCooldown > this.state.config.baseCooldown) {
    this.state.globalCooldown = Math.max(
      this.state.config.baseCooldown,
      this.state.globalCooldown * 0.9
    );
  }
}
```

6. **Sistema de Logs Inteligente**
- Categoriza√ß√£o autom√°tica de tipos de erro
- Supress√£o inteligente de mensagens repetitivas
- Logs contextualizados com informa√ß√µes dos rob√¥s e opera√ß√µes
```typescript
// Logs categorizados que evitam spam no console
static error(message: string, context?: LogContext): void {
  if (this.isRateLimitMessage(message)) {
    if (this.shouldSuppressRateLimitLog(message)) {
      logtail.debug(`[RATE_LIMIT_ERROR] ${message}`);
      return;
    }
    logtail.warn(`[RATE_LIMIT] ${message}`);
  }
}
```

7. **Arquitetura Modular**
- Separa√ß√£o clara de responsabilidades
- Servi√ßos independentes e bem definidos
- Sistema de tipos forte com TypeScript

Cada um destes destaques t√©cnicos foi implementado pensando em performance, manutenibilidade e confiabilidade do sistema.

## üîê Seguran√ßa e Robustez

- **Rate limiting inteligente com recupera√ß√£o autom√°tica**
  - Detec√ß√£o autom√°tica de diferentes tipos de erro (429, 403, timeout)
  - Pausas escalonadas baseadas na frequ√™ncia de erros
  - Recupera√ß√£o gradual com cooldowns adaptativos
- **Prote√ß√£o contra duplica√ß√£o de dados**
- **Valida√ß√£o rigorosa de entradas**
- **Gerenciamento seguro de tokens e credenciais**
- **Sistema de backup autom√°tico e restaura√ß√£o de dados**

## üìä Funcionalidades de Monitoramento

- **Rastreamento em tempo real** de mortes (PvP e PvE)
- **An√°lise avan√ßada** de estat√≠sticas e hist√≥rico de combates
- **Sistema de ranking** e guerra entre times com per√≠odos customiz√°veis
- **Logs detalhados** de mortes por monstros e trocas de classe
- **Monitoramento do sistema**: Status dos rob√¥s, rate limiting e performance
- **M√©tricas em tempo real**: Taxa de sucesso, tend√™ncias de erro, cooldowns
- **Alertas autom√°ticos**: Detec√ß√£o de problemas e recomenda√ß√µes de a√ß√£o

## üõ†Ô∏è Recursos T√©cnicos Avan√ßados

- **Arquitetura modular e escal√°vel** com servi√ßos independentes
- **Sistema de logging inteligente** com categoriza√ß√£o e supress√£o autom√°tica
- **Rate limiting adaptativo** com otimiza√ß√£o autom√°tica
- **Persist√™ncia de estado** para recupera√ß√£o ap√≥s reinicializa√ß√µes
- **Processamento paralelo** com sistema de filas e rob√¥s
- **Monitoramento em tempo real** com m√©tricas detalhadas
- **Testes automatizados** com ambiente isolado
- **Tratamento robusto de erros** com recupera√ß√£o autom√°tica

---

## ‚úÖ Funcionalidades Implementadas

- [‚úÖ] **Sistema de Rate Limiting Inteligente** ‚Äî Solu√ß√£o robusta para erro 429 com recupera√ß√£o autom√°tica
- [‚úÖ] **Persist√™ncia de Estado** ‚Äî Sistema nunca perde progresso ap√≥s reinicializa√ß√µes
- [‚úÖ] **Logs Inteligentes** ‚Äî Console limpo com categoriza√ß√£o autom√°tica de erros
- [‚úÖ] **Monitoramento do Sistema** ‚Äî Comando `/systemstatus` para acompanhar performance em tempo real
- [‚úÖ] **Otimiza√ß√£o Autom√°tica** ‚Äî Sistema se ajusta automaticamente para m√°xima efici√™ncia
- [‚úÖ] Registro de mortes por monstros e envio para canal espec√≠fico
- [‚úÖ] Registro de troca de classe e envio para canal espec√≠fico
- [‚úÖ] Fun√ß√£o de guerra com an√°lise de per√≠odo customiz√°vel e ranking de aliados

## üìã Pr√≥ximas Melhorias

- [ ] **Importa√ß√£o de lista de jogadores:** Comando Discord para importar lista de jogadores em lote
- [ ] **Dashboard web:** Interface web para monitoramento avan√ßado do sistema
- [ ] **Alertas proativos:** Notifica√ß√µes quando sistema detecta problemas potenciais
- [ ] **M√©tricas hist√≥ricas:** Gr√°ficos de performance e tend√™ncias ao longo do tempo
- [ ] **Configura√ß√£o din√¢mica:** Ajuste de par√¢metros do sistema via comandos Discord